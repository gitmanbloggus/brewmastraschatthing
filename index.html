<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App v2</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #000000;
      color: #dcddde;
      overflow: hidden;
      height: 100vh;
    }
    #auth {
      max-width: 400px;
      margin: 50px auto;
      background: #1a1a1a;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(255,0,0,0.2);
      border: 1px solid #2a2a2a;
    }
    #auth h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #ff3333;
      text-align: center;
    }
    #auth input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #333;
      border-radius: 5px;
      background: #0a0a0a;
      color: #e0e0e0;
    }
    #auth input:focus {
      outline: none;
      border-color: #ff3333;
    }
    #auth button {
      width: 48%;
      padding: 10px;
      margin: 5px 1%;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    #loginBtn {
      background: #ff3333;
      color: white;
    }
    #loginBtn:hover {
      background: #ff5555;
    }
    #registerBtn {
      background: #333;
      color: white;
      border: 1px solid #ff3333;
    }
    #registerBtn:hover {
      background: #ff3333;
    }
    #chat {
      display: none;
      height: 100vh;
      flex-direction: row;
    }
    .sidebar {
      width: 280px;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #0a0a0a;
      position: relative;
    }
    .sidebar-header {
      padding: 15px;
      background: #0a0a0a;
      border-bottom: 1px solid #000;
    }
    .sidebar-header h3 {
      color: #ff3333;
      font-size: 16px;
      margin-bottom: 10px;
    }
    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .nav-btn {
      background: transparent;
      color: #b9bbbe;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      text-align: left;
      font-weight: 500;
    }
    .nav-btn:hover {
      background: #2a2a2a;
      color: #dcddde;
    }
    .nav-btn.active {
      background: #ff3333;
      color: white;
    }
    .conversations-container {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .conversation-item {
      padding: 10px 12px;
      margin: 2px 0;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #b9bbbe;
      position: relative;
    }
    .conversation-item:hover {
      background: #2a2a2a;
      color: #dcddde;
    }
    .conversation-item.active {
      background: #ff3333;
      color: white;
    }
    .conversation-info {
      flex: 1;
      min-width: 0;
    }
    .conversation-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .conversation-members {
      font-size: 12px;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .delete-conversation {
      background: transparent;
      color: #b9bbbe;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      opacity: 0;
    }
    .conversation-item:hover .delete-conversation {
      opacity: 1;
    }
    .delete-conversation:hover {
      background: #ff3333;
      color: white;
    }
    .conversation-item.active .delete-conversation {
      color: white;
      opacity: 1;
    }
    .unread-badge {
      position: absolute;
      top: 50%;
      left: 8px;
      transform: translateY(-50%);
      background: #ff3333;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      border: 2px solid #1a1a1a;
    }
    .conversation-item.active .unread-badge {
      background: #cc0000;
      border-color: #ff3333;
    }
    .conversation-item .conversation-info {
      margin-left: 28px;
    }
    .message-image {
      max-width: 300px;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .message-image:hover {
      transform: scale(1.02);
    }
    .message-file {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      background: #2a2a2a;
      border-radius: 6px;
      margin-top: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .message-file:hover {
      background: #333;
    }
    .file-icon {
      font-size: 24px;
    }
    .file-info {
      display: flex;
      flex-direction: column;
    }
    .file-name {
      font-weight: 500;
      color: #dcddde;
    }
    .file-size {
      font-size: 12px;
      color: #72767d;
    }
    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      cursor: pointer;
      color: #b9bbbe;
      transition: color 0.3s;
    }
    .file-input-label:hover {
      color: #ff3333;
    }
    .file-input-label input {
      display: none;
    }
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      cursor: pointer;
    }
    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    .user-info {
      padding: 15px;
      background: #0a0a0a;
      border-top: 1px solid #000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .username-display {
      color: #ff3333;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: color 0.3s;
    }
    .username-display:hover {
      color: #ff5555;
    }
    .logout-btn {
      background: #333;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }
    .logout-btn:hover {
      background: #ff3333;
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0a0a0a;
      overflow: hidden;
    }
    #chatView {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .chat-header {
      height: 60px;
      padding: 0 20px;
      background: #1a1a1a;
      border-bottom: 1px solid #0a0a0a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .chat-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }
    .chat-members {
      font-size: 13px;
      color: #b9bbbe;
    }
    .messages-container {
      flex: 1;
      overflow-y: scroll !important;
      overflow-x: hidden;
      padding: 20px;
      max-height: calc(100vh - 180px);
      min-height: 200px;
    }
    .message {
      margin-bottom: 16px;
      padding: 8px 12px;
      background: #1a1a1a;
      border-radius: 6px;
      border-left: 3px solid #ff3333;
      position: relative;
    }
    .message.own {
      border-left-color: #cc0000;
      background: #2a0a0a;
    }
    .message-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }
    .message-author {
      font-weight: 600;
      font-size: 14px;
      color: #ff3333;
    }
    .message.own .message-author {
      color: #ff5555;
    }
    .message-timestamp {
      font-size: 11px;
      color: #72767d;
    }
    .message-text {
      font-size: 14px;
      color: #dcddde;
      word-wrap: break-word;
      padding-right: 60px;
    }
    .message-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: none;
      gap: 4px;
    }
    .message:hover .message-actions {
      display: flex;
    }
    .message-action-btn {
      background: #2a2a2a;
      color: #b9bbbe;
      border: none;
      padding: 6px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }
    .message-action-btn:hover {
      background: #ff3333;
      color: white;
    }
    .message-edited {
      font-size: 10px;
      color: #72767d;
      font-style: italic;
      margin-left: 4px;
    }
    .message-deleted {
      opacity: 0.5;
      font-style: italic;
    }
    .message-input-container {
      padding: 20px;
      background: #1a1a1a;
      flex-shrink: 0;
    }
    .message-input-wrapper {
      display: flex;
      gap: 10px;
      background: #0a0a0a;
      padding: 10px;
      border-radius: 8px;
    }
    .message-input-wrapper input {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      color: #dcddde;
      font-size: 14px;
    }
    .message-input-wrapper input:focus {
      outline: none;
    }
    .message-input-wrapper input::placeholder {
      color: #72767d;
    }
    .send-btn {
      padding: 10px 16px;
      background: #ff3333;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .send-btn:hover {
      background: #ff5555;
    }
    .send-btn:disabled {
      background: #333;
      cursor: not-allowed;
    }
    .empty-state {
      text-align: center;
      padding: 60px 40px;
      color: #72767d;
    }
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #b9bbbe;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #1a1a1a;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(255,0,0,0.5);
      border: 1px solid #2a2a2a;
      max-width: 500px;
      width: 90%;
    }
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 16px;
      color: #fff;
    }
    .modal-content {
      margin-bottom: 20px;
    }
    .modal-input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #333;
      border-radius: 5px;
      background: #0a0a0a;
      color: #dcddde;
      font-size: 14px;
    }
    .modal-input:focus {
      outline: none;
      border-color: #ff3333;
    }
    .modal-label {
      display: block;
      margin-bottom: 8px;
      color: #b9bbbe;
      font-size: 13px;
      font-weight: 600;
    }
    .user-select-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #333;
      border-radius: 5px;
      background: #0a0a0a;
      margin-top: 8px;
    }
    .user-select-item {
      padding: 10px;
      display: flex;
      align-items: center;
      cursor: pointer;
      border-bottom: 1px solid #1a1a1a;
    }
    .user-select-item:hover {
      background: #2a2a2a;
    }
    .user-select-item:last-child {
      border-bottom: none;
    }
    .user-checkbox {
      margin-right: 10px;
      cursor: pointer;
    }
    .selected-users {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .selected-user-tag {
      background: #ff3333;
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .remove-user {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      line-height: 1;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    .modal-btn.cancel {
      background: #333;
      color: white;
    }
    .modal-btn.cancel:hover {
      background: #444;
    }
    .modal-btn.confirm {
      background: #ff3333;
      color: white;
    }
    .modal-btn.confirm:hover {
      background: #ff5555;
    }
    .modal-btn.create {
      background: #ff3333;
      color: white;
    }
    .modal-btn.create:hover {
      background: #ff5555;
    }
    .modal-btn.create:disabled {
      background: #333;
      cursor: not-allowed;
    }
    .friends-container {
      padding: 20px;
      height: 100%;
      overflow-y: auto;
    }
    .friends-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #2a2a2a;
    }
    .friends-header h2 {
      color: #fff;
      font-size: 20px;
    }
    .friends-tabs {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid #2a2a2a;
    }
    .friends-tab {
      padding: 10px 15px;
      background: none;
      border: none;
      color: #b9bbbe;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }
    .friends-tab:hover {
      color: #dcddde;
    }
    .friends-tab.active {
      color: #ff3333;
      border-bottom-color: #ff3333;
    }
    .friend-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin: 5px 0;
      background: #1a1a1a;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .friend-item:hover {
      background: #2a2a2a;
    }
    .friend-name {
      font-weight: 600;
      color: #dcddde;
      font-size: 15px;
    }
    .friend-status {
      font-size: 12px;
      color: #72767d;
      margin-top: 3px;
    }
    .friend-actions {
      display: flex;
      gap: 8px;
    }
    .friend-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s;
    }
    .friend-btn.message {
      background: #ff3333;
      color: white;
    }
    .friend-btn.message:hover {
      background: #ff5555;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(255, 51, 51, 0.3);
    }
    .friend-btn.accept {
      background: #28a745;
      color: white;
    }
    .friend-btn.accept:hover {
      background: #34ce57;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }
    .friend-btn.decline {
      background: #2a2a2a;
      color: #dcddde;
      border: 1px solid #444;
    }
    .friend-btn.decline:hover {
      background: #333;
      border-color: #666;
    }
    .friend-btn.remove {
      background: #2a2a2a;
      color: #ff6b6b;
      border: 1px solid #ff3333;
    }
    .friend-btn.remove:hover {
      background: #dc3545;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }
    .add-friend-section {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .add-friend-section h3 {
      color: #fff;
      font-size: 16px;
      margin-bottom: 12px;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1a1a1a;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(255,0,0,0.4);
      border: 1px solid #2a2a2a;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 250px;
      max-width: 400px;
      animation: slideIn 0.3s ease;
      color: #dcddde;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .toast.success { border-left: 4px solid #ff3333; }
    .toast.error { border-left: 4px solid #ff6666; }
    .toast.warning { border-left: 4px solid #ff9933; }
    .toast.info { border-left: 4px solid #ff3333; }
    .toast-icon {
      font-size: 24px;
      color: #ff3333;
    }
    .toast-message { flex: 1; }
    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 24px;
      height: 24px;
    }
    .toast-close:hover { color: #ff3333; }
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: #0a0a0a;
    }
    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #ff3333;
    }
    .new-dm-btn {
      background: #ff3333;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.3s;
    }
    .new-dm-btn:hover {
      background: #ff5555;
    }
    .profile-modal {
      position: absolute;
      bottom: 70px;
      left: 15px;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(255,0,0,0.5);
      width: 280px;
      z-index: 1000;
      display: none;
    }
    .profile-modal.show {
      display: block;
    }
    .profile-modal-header {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #2a2a2a;
    }
    .profile-modal-field {
      margin-bottom: 15px;
    }
    .profile-modal-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #b9bbbe;
      margin-bottom: 6px;
    }
    .profile-modal-input {
      width: 100%;
      padding: 8px;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #dcddde;
      font-size: 14px;
    }
    .profile-modal-input:focus {
      outline: none;
      border-color: #ff3333;
    }
    .profile-modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }
    .profile-modal-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.3s;
    }
    .profile-modal-btn.save {
      background: #ff3333;
      color: white;
    }
    .profile-modal-btn.save:hover {
      background: #ff5555;
    }
    .profile-modal-btn.cancel {
      background: #333;
      color: #dcddde;
    }
    .profile-modal-btn.cancel:hover {
      background: #444;
    }
  </style>
</head>
<body>
  <div id="auth">
    <h2>Welcome</h2>
    <input id="username" placeholder="Username" />
    <input id="password" type="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
  </div>
  
  <div id="chat">
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Messages</h3>
        <div class="sidebar-nav">
          <button class="nav-btn" id="friendsBtn">Friends</button>
          <button class="nav-btn" id="settingsBtn">Settings</button>
        </div>
      </div>
      <div style="padding: 8px;">
        <button style="width: 100%; background: #ff3333; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.3s;" id="newDmBtn" onmouseover="this.style.background='#ff5555'" onmouseout="this.style.background='#ff3333'">+ New Chat</button>
      </div>
      <div class="conversations-container" id="conversationsList">
        <div class="empty-state">
          <div class="empty-state-title">No conversations yet</div>
          <div>Start a DM or create a group</div>
        </div>
      </div>
      <div class="user-info">
        <div class="username-display" id="usernameDisplay"></div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
      
      <!-- Profile Modal -->
      <div class="profile-modal" id="profileModal">
        <div class="profile-modal-header">Edit Profile</div>
        <div class="profile-modal-field">
          <label class="profile-modal-label">Display Name</label>
          <input type="text" class="profile-modal-input" id="profileUsernameInput" placeholder="Enter new display name" />
          <div style="font-size: 11px; color: #72767d; margin-top: 4px;">This is what everyone sees. Login username stays the same.</div>
        </div>
        <div class="profile-modal-buttons">
          <button class="profile-modal-btn cancel" id="profileCancelBtn">Cancel</button>
          <button class="profile-modal-btn save" id="profileSaveBtn">Save</button>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <div id="settingsView" style="display:none; height: 100%; overflow-y: auto;">
        <div class="friends-container">
          <div class="friends-header">
            <h2>Settings</h2>
            <button class="new-dm-btn" id="backFromSettingsBtn">‚Üê Back</button>
          </div>
          
          <div class="add-friend-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
              <div>
                <div style="font-weight: 600; color: #dcddde; margin-bottom: 5px;">Freedom of Speech</div>
                <div style="font-size: 13px; color: #72767d;">When enabled, non-friends may speak to you</div>
              </div>
              <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                <input type="checkbox" id="allowNonFriendsDM" style="opacity: 0; width: 0; height: 0;">
                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px;"></span>
                <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;"></span>
              </label>
            </div>
          </div>

          <div class="add-friend-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
              <div>
                <div style="font-weight: 600; color: #dcddde; margin-bottom: 5px;">Show Timestamps</div>
                <div style="font-size: 13px; color: #72767d;">Shows timestamps</div>
              </div>
              <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                <input type="checkbox" id="showTimestamps" checked style="opacity: 0; width: 0; height: 0;">
                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px;"></span>
                <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;"></span>
              </label>
            </div>
          </div>

          <div class="add-friend-section" id="adminPanel" style="display:none;">
            <h3 style="color: #ff3333;">Privileges</h3>
            <p style="color: #b9bbbe; font-size: 13px; margin-bottom: 15px;">You are privileged</p>
            <button class="new-dm-btn" id="manageUsersBtn" style="margin-right: 10px;">End them all</button>
            <button class="new-dm-btn" id="viewAllMessagesBtn">View All Messages</button>
          </div>
        </div>
      </div>

      <div id="friendsView" style="display:none; height: 100%; overflow-y: auto;">
        <div class="friends-container">
          <div class="friends-header">
            <h2>Friends</h2>
            <button class="new-dm-btn" id="backToMessagesBtn">‚Üê Back</button>
          </div>
          
          <div class="friends-tabs">
            <button class="friends-tab active" data-tab="all">All</button>
            <button class="friends-tab" data-tab="pending">Pending</button>
            <button class="friends-tab" data-tab="add">Add Friend</button>
          </div>
          
          <div id="addFriendTab" style="display:none;">
            <div class="add-friend-section">
              <h3>Add Friend</h3>
              <div style="position: relative;">
                <input id="addFriendInput" class="modal-input" placeholder="" autocomplete="off" />
                <div id="addFriendDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: #1a1a1a; border: 1px solid #333; border-radius: 5px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; margin-top: 5px;">
                </div>
              </div>
            </div>
          </div>
          
          <div id="friendsListContainer"></div>
        </div>
      </div>
      
      <div id="chatView">
        <div class="chat-header" id="chatHeader" style="display:none;">
          <div>
            <div class="chat-title" id="chatTitle"></div>
            <div class="chat-members" id="chatMembers"></div>
          </div>
        </div>
        <div class="messages-container" id="messagesContainer">
          <div class="empty-state">
            <div>click on the buttons</div>
          </div>
        </div>
        <div class="message-input-container" id="messageInputContainer" style="display:none;">
          <div class="message-input-wrapper">
            <input id="messageInput" placeholder="Type a message..." disabled />
            <button id="sendBtn" class="send-btn" disabled>‚û§</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDocs, where, serverTimestamp, deleteDoc, updateDoc, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzt2lJe_cIK_U7Uh88Wun73dG7GxQMYh4",
      authDomain: "tankaportalv2.firebaseapp.com",
      projectId: "tankaportalv2",
      storageBucket: "tankaportalv2.firebasestorage.app",
      messagingSenderId: "187174097219",
      appId: "1:187174097219:web:0987e83cd8e8d2c101dff6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    let currentConversation = null;
    let currentDMListener = null;
    let conversationsListener = null;
    let friendsListener = null;
    let readTimesListener = null;
    let messageListeners = new Map();
    let conversations = new Map();
    let currentFriendsTab = 'all';
    let allUsers = [];
    let userSettings = {
      allowNonFriendsDM: true,
      showTimestamps: true
    };
    const ADMIN_USERNAMES = ['TankaJahari'];
    let unreadCount = 0;
    let lastMessageCounts = new Map();
    let conversationUnreadCounts = new Map();
    let readTimes = new Map();
    let profileModalOpen = false;
    let editingMessageId = null;
    let editingMessageText = "";

    function updatePageTitle() {
      const baseTitle = "Chat";
      if (unreadCount > 0) {
        document.title = unreadCount >= 9 ? `${baseTitle} (9+)` : `${baseTitle} (${unreadCount})`;
      } else {
        document.title = baseTitle;
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
      toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-message">${message}</div>
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function fakeEmail(username) {
      return `${username}@chatapp.com`;
    }

    function getConversationId(users) {
      return users.sort().join("_");
    }

    async function loadAllUsers() {
      const usersRef = collection(db, "users");
      const snapshot = await getDocs(usersRef);
      allUsers = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const username = data.username;
        if (username !== auth.currentUser?.displayName) {
          allUsers.push({
            username: username,
            displayName: data.displayName || username
          });
        }
      });
    }

    async function loadUserSettings() {
      try {
        const settingsDoc = await getDocs(query(collection(db, "userSettings"), where("userId", "==", auth.currentUser.uid)));
        if (!settingsDoc.empty) {
          const data = settingsDoc.docs[0].data();
          userSettings = { ...userSettings, ...data };
        }
        document.getElementById("allowNonFriendsDM").checked = userSettings.allowNonFriendsDM;
        document.getElementById("showTimestamps").checked = userSettings.showTimestamps;
        
        if (ADMIN_USERNAMES.includes(auth.currentUser.displayName)) {
          const adminPanel = document.getElementById("adminPanel");
          if (adminPanel) {
            adminPanel.style.display = "block";
          }
        }
        
        setupToggleSwitches();
      } catch (error) {
        console.log("Settings load error:", error);
      }
    }

    const manageUsersBtn = document.getElementById("manageUsersBtn");
    if (manageUsersBtn) {
      manageUsersBtn.onclick = showManageUsersModal;
    }

    const viewAllMessagesBtn = document.getElementById("viewAllMessagesBtn");
    if (viewAllMessagesBtn) {
      viewAllMessagesBtn.onclick = showViewAllMessagesModal;
    }

    function showViewAllMessagesModal() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal" style="max-width: 800px;">
          <div class="modal-title">View All Messages (Admin)</div>
          <div class="modal-content">
            <div id="allConversationsList" style="max-height: 500px; overflow-y: auto;">
              <p style="color: #72767d; text-align: center;">Loading conversations...</p>
            </div>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      loadAllConversationsForAdmin();
      
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    async function loadAllConversationsForAdmin() {
      const dmsRef = collection(db, "dms");
      const snapshot = await getDocs(dmsRef);
      const container = document.getElementById("allConversationsList");
      container.innerHTML = '';
      
      if (snapshot.empty) {
        container.innerHTML = '<p style="color: #72767d; text-align: center;">No conversations found</p>';
        return;
      }
      
      for (const docSnap of snapshot.docs) {
        const data = docSnap.data();
        const convId = docSnap.id;
        
        const displayName = data.groupName || data.members.join(", ");
        const isGroup = data.members.length > 2;
        
        const div = document.createElement('div');
        div.className = 'friend-item';
        div.style.cursor = 'pointer';
        div.innerHTML = `
          <div>
            <div class="friend-name">${isGroup ? 'Group: ' : ''}${displayName}</div>
            <div class="friend-status">${data.members.length} members: ${data.members.join(", ")}</div>
          </div>
          <div class="friend-actions">
            <button class="friend-btn message">View Messages</button>
          </div>
        `;
        
        div.querySelector('.message').onclick = () => viewConversationMessages(convId, displayName);
        container.appendChild(div);
      }
    }

    async function viewConversationMessages(conversationId, displayName) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal" style="max-width: 900px;">
          <div class="modal-title">Admin View: ${displayName}</div>
          <div class="modal-content">
            <p style="color: #ff9933; font-size: 12px; margin-bottom: 10px; padding: 8px; background: #1a1a1a; border-radius: 4px;">
              üìã Viewing all messages including deleted and edited ones
            </p>
            <div id="adminMessagesList" style="max-height: 600px; overflow-y: auto; background: #0a0a0a; padding: 15px; border-radius: 8px;">
              <p style="color: #72767d; text-align: center;">Loading messages...</p>
            </div>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Back</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      const messagesRef = collection(db, "dms", conversationId, "messages");
      const q = query(messagesRef, orderBy("createdAt", "asc"));
      const messagesSnapshot = await getDocs(q);
      
      const container = document.getElementById("adminMessagesList");
      container.innerHTML = '';
      
      if (messagesSnapshot.empty) {
        container.innerHTML = '<p style="color: #72767d; text-align: center;">No messages yet</p>';
      } else {
        messagesSnapshot.forEach(msgDoc => {
          const msgData = msgDoc.data();
          const div = document.createElement('div');
          div.className = 'message';
          
          if (msgData.deleted) {
            div.style.background = '#3a0a0a';
            div.style.borderLeft = '3px solid #ff6666';
          }
          
          let timestamp = "";
          if (msgData.createdAt) {
            const date = msgData.createdAt.toDate();
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            
            if (isToday) {
              timestamp = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            } else {
              timestamp = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + 
                         date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }
          }
          
          let messageContent = '';
          
          // Show deleted status
          if (msgData.deleted) {
            messageContent += `<div style="color: #ff6666; font-weight: 600; margin-bottom: 4px;">üóëÔ∏è [DELETED MESSAGE]</div>`;
            if (msgData.deletedAt) {
              const deletedDate = msgData.deletedAt.toDate();
              const deletedTime = deletedDate.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
              });
              messageContent += `<div style="color: #72767d; font-size: 11px; margin-bottom: 8px;">Deleted at: ${deletedTime}</div>`;
            }
          }
          
          // Show original message if edited
          if (msgData.edited && msgData.originalText) {
            messageContent += `
              <div style="background: #1a1a1a; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                <div style="color: #ff9933; font-size: 11px; font-weight: 600; margin-bottom: 4px;">üìù ORIGINAL:</div>
                <div style="color: #b9bbbe;">${msgData.originalText}</div>
              </div>
            `;
          }
          
          // Show current/edited message
          if (msgData.edited) {
            messageContent += `
              <div style="background: #1a1a1a; padding: 8px; border-radius: 4px;">
                <div style="color: #ff9933; font-size: 11px; font-weight: 600; margin-bottom: 4px;">‚úèÔ∏è EDITED:</div>
                <div style="color: #dcddde;">${msgData.text}</div>
              </div>
            `;
            if (msgData.editedAt) {
              const editedDate = msgData.editedAt.toDate();
              const editedTime = editedDate.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
              });
              messageContent += `<div style="color: #72767d; font-size: 11px; margin-top: 4px;">Edited at: ${editedTime}</div>`;
            }
          } else {
            messageContent += `<div style="color: #dcddde;">${msgData.text}</div>`;
          }
          
          div.innerHTML = `
            <div class="message-header">
              <div class="message-author">${msgData.from}</div>
              <div class="message-timestamp">${timestamp}</div>
            </div>
            <div class="message-text">${messageContent}</div>
          `;
          container.appendChild(div);
        });
        
        setTimeout(() => {
          container.scrollTop = container.scrollHeight;
        }, 50);
      }
      
      overlay.querySelector('.cancel').onclick = () => {
        overlay.remove();
        showViewAllMessagesModal();
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) {
          overlay.remove();
          showViewAllMessagesModal();
        }
      };
    }

    function showManageUsersModal() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Manage Users (Admin)</div>
          <div class="modal-content">
            <div id="userManagementList" style="max-height: 400px; overflow-y: auto;">
              <p style="color: #72767d; text-align: center;">Loading users...</p>
            </div>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      loadAllUsersForAdmin();
      
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    async function loadAllUsersForAdmin() {
      const usersRef = collection(db, "users");
      const snapshot = await getDocs(usersRef);
      const container = document.getElementById("userManagementList");
      container.innerHTML = '';
      
      snapshot.forEach(docSnap => {
        const username = docSnap.data().username;
        const userId = docSnap.id;
        
        const div = document.createElement('div');
        div.className = 'friend-item';
        div.innerHTML = `
          <div>
            <div class="friend-name">${username}</div>
            <div class="friend-status">UID: ${userId}</div>
          </div>
          <div class="friend-actions">
            <button class="friend-btn remove">Delete User</button>
          </div>
        `;
        
        div.querySelector('.remove').onclick = () => deleteUserAccount(userId, username);
        container.appendChild(div);
      });
    }

    async function deleteUserAccount(userId, username) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Delete User Account</div>
          <div class="modal-content">
            <p style="color:#b9bbbe;">Are you sure you want to delete ${username}?</p>
            <p style="color:#ff6666; font-size: 13px; margin-top: 10px;">Warning: This will delete their user document but NOT their Firebase Auth account. They won't be able to log in with their credentials anymore, but the auth account will still exist in Firebase Auth.</p>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn confirm">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('.confirm').onclick = async () => {
        try {
          await deleteDoc(doc(db, "users", userId));
          
          const friendRequestsRef = collection(db, "friendRequests");
          const friendsSnap = await getDocs(friendRequestsRef);
          friendsSnap.forEach(async (docSnap) => {
            const data = docSnap.data();
            if (data.from === username || data.to === username) {
              await deleteDoc(docSnap.ref);
            }
          });
          
          overlay.remove();
          showToast(`User ${username} deleted`, "success");
          loadAllUsersForAdmin();
        } catch (error) {
          showToast("Failed to delete user", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    function setupToggleSwitches() {
      const switches = ['allowNonFriendsDM', 'showTimestamps'];
      switches.forEach(id => {
        const checkbox = document.getElementById(id);
        const toggle = checkbox.nextElementSibling;
        const slider = toggle.nextElementSibling;
        
        function updateToggle() {
          if (checkbox.checked) {
            toggle.style.backgroundColor = '#ff3333';
            slider.style.transform = 'translateX(26px)';
          } else {
            toggle.style.backgroundColor = '#333';
            slider.style.transform = 'translateX(0)';
          }
        }
        
        updateToggle();
        
        checkbox.onchange = async () => {
          updateToggle();
          userSettings[id] = checkbox.checked;
          try {
            await setDoc(doc(db, "userSettings", auth.currentUser.uid), {
              userId: auth.currentUser.uid,
              ...userSettings
            });
            showToast("Settings saved", "success");
          } catch (error) {
            showToast("Failed to save settings", "error");
          }
        };
      });
    }

    // Profile Modal Event Listeners
    document.getElementById("usernameDisplay").onclick = (e) => {
      e.stopPropagation();
      const modal = document.getElementById("profileModal");
      const input = document.getElementById("profileUsernameInput");
      
      if (profileModalOpen) {
        modal.classList.remove('show');
        profileModalOpen = false;
      } else {
        input.value = auth.currentUser.displayName;
        modal.classList.add('show');
        profileModalOpen = true;
      }
    };

    document.getElementById("profileCancelBtn").onclick = () => {
      document.getElementById("profileModal").classList.remove('show');
      profileModalOpen = false;
    };

    document.getElementById("profileSaveBtn").onclick = async () => {
      const newDisplayName = document.getElementById("profileUsernameInput").value.trim();
      
      if (!newDisplayName) {
        showToast("Display name cannot be empty", "error");
        return;
      }
      
      if (newDisplayName === auth.currentUser.displayName) {
        showToast("That's already your display name", "warning");
        return;
      }
      
      if (newDisplayName.length < 3) {
        showToast("Display name must be at least 3 characters", "error");
        return;
      }
      
      if (newDisplayName.length > 20) {
        showToast("Display name must be less than 20 characters", "error");
        return;
      }
      
      // Close modal immediately
      document.getElementById("profileModal").classList.remove('show');
      profileModalOpen = false;
      
      try {
        const oldDisplayName = auth.currentUser.displayName;
        
        // Update auth profile
        await updateProfile(auth.currentUser, { displayName: newDisplayName });
        
        // Update user document (keep username the same, only update displayName)
        await updateDoc(doc(db, "users", auth.currentUser.uid), { 
          displayName: newDisplayName 
        });
        
        // Update all conversations where user is a member
        const dmsRef = collection(db, "dms");
        const dmsSnapshot = await getDocs(dmsRef);
        
        for (const dmDoc of dmsSnapshot.docs) {
          const data = dmDoc.data();
          if (data.members && data.members.includes(oldDisplayName)) {
            const updatedMembers = data.members.map(m => m === oldDisplayName ? newDisplayName : m);
            await updateDoc(dmDoc.ref, { members: updatedMembers });
          }
        }
        
        // Update all messages from this user
        for (const dmDoc of dmsSnapshot.docs) {
          const messagesRef = collection(db, "dms", dmDoc.id, "messages");
          const messagesSnapshot = await getDocs(messagesRef);
          
          for (const msgDoc of messagesSnapshot.docs) {
            const msgData = msgDoc.data();
            if (msgData.from === oldDisplayName) {
              await updateDoc(msgDoc.ref, { from: newDisplayName });
            }
          }
        }
        
        // Update friend requests
        const friendRequestsRef = collection(db, "friendRequests");
        const friendsSnapshot = await getDocs(friendRequestsRef);
        
        for (const friendDoc of friendsSnapshot.docs) {
          const data = friendDoc.data();
          const updates = {};
          
          if (data.from === oldDisplayName) updates.from = newDisplayName;
          if (data.to === oldDisplayName) updates.to = newDisplayName;
          
          if (Object.keys(updates).length > 0) {
            await updateDoc(friendDoc.ref, updates);
          }
        }
        
        // Update read times
        const readTimesRef = collection(db, "readTimes");
        const readTimesSnapshot = await getDocs(query(readTimesRef, where("userId", "==", oldDisplayName)));
        
        for (const readDoc of readTimesSnapshot.docs) {
          await updateDoc(readDoc.ref, { userId: newDisplayName });
        }
        
        // Update UI
        document.getElementById("usernameDisplay").textContent = newDisplayName;
        
        showToast("Display name updated!", "success");
        
        // Refresh to show updated data
        setTimeout(() => {
          hardRefresh();
        }, 1500);
        
      } catch (error) {
        console.error("Error updating display name:", error);
        showToast("Failed to update display name", "error");
      }
    };

    // Close profile modal when clicking outside
    document.addEventListener('click', (e) => {
      const modal = document.getElementById("profileModal");
      const usernameDisplay = document.getElementById("usernameDisplay");
      
      if (profileModalOpen && !modal.contains(e.target) && !usernameDisplay.contains(e.target)) {
        modal.classList.remove('show');
        profileModalOpen = false;
      }
    });

    document.getElementById("registerBtn").onclick = async () => {
      try {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        if (!username || !password) {
          showToast("Please enter username and password", "error");
          return;
        }
        if (password.length < 6) {
          showToast("Password must be at least 6 characters", "error");
          return;
        }
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("username", "==", username));
        const snap = await getDocs(q);
        if (!snap.empty) {
          showToast("Username already taken", "error");
          return;
        }
        const email = fakeEmail(username);
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCredential.user, { displayName: username });
        await setDoc(doc(db, "users", userCredential.user.uid), { 
          username: username,
          displayName: username
        });
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
      } catch (error) {
        showToast(error.message, "error");
      }
    };

    document.getElementById("loginBtn").onclick = async () => {
      try {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        if (!username || !password) {
          showToast("Please enter username and password", "error");
          return;
        }
        const email = fakeEmail(username);
        await signInWithEmailAndPassword(auth, email, password);
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
      } catch (error) {
        showToast("Invalid username or password", "error");
      }
    };

    document.getElementById("logoutBtn").onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("auth").style.display = "none";
        document.getElementById("chat").style.display = "flex";
        document.getElementById("usernameDisplay").textContent = user.displayName;
        loadConversations();
        loadUserSettings();
        loadAllUsers();
      } else {
        document.getElementById("auth").style.display = "block";
        document.getElementById("chat").style.display = "none";
        if (currentDMListener) currentDMListener();
        if (conversationsListener) conversationsListener();
        if (friendsListener) friendsListener();
        if (readTimesListener) readTimesListener();
        messageListeners.forEach(listener => listener());
        messageListeners.clear();
        conversations.clear();
        currentConversation = null;
        allUsers = [];
        readTimes.clear();
      }
    });

    function hardRefresh() {
      if (currentDMListener) currentDMListener();
      if (conversationsListener) conversationsListener();
      if (friendsListener) friendsListener();
      if (readTimesListener) readTimesListener();
      messageListeners.forEach(listener => listener());
      messageListeners.clear();
      
      conversations.clear();
      conversationUnreadCounts.clear();
      readTimes.clear();
      allUsers = [];
      unreadCount = 0;
      lastMessageCounts.clear();
      
      currentConversation = null;
      document.getElementById("chatHeader").style.display = "none";
      document.getElementById("messageInputContainer").style.display = "none";
      document.getElementById("messagesContainer").innerHTML = `
        <div class="empty-state">
          <div>click on the buttons</div>
        </div>
      `;
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("chatView").style.flexDirection = "column";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      
      if (auth.currentUser) {
        loadConversations();
        loadUserSettings();
        loadAllUsers();
        showToast("Refreshed!", "success");
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === '0') {
        e.preventDefault();
        hardRefresh();
      }
    });

    async function markConversationAsRead(conversationId) {
      const currentUser = auth.currentUser.displayName;
      const readTimeId = `${currentUser}_${conversationId}`;
      
      try {
        await setDoc(doc(db, "readTimes", readTimeId), {
          userId: currentUser,
          conversationId: conversationId,
          lastRead: serverTimestamp()
        });
      } catch (error) {
        console.log("Failed to update read time:", error);
      }
    }

    function loadConversations() {
      const currentUser = auth.currentUser.displayName;
      const dmsRef = collection(db, "dms");
      
      const readTimesRef = collection(db, "readTimes");
      const readTimesQuery = query(readTimesRef, where("userId", "==", currentUser));
      readTimesListener = onSnapshot(readTimesQuery, snapshot => {
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          readTimes.set(data.conversationId, data.lastRead?.toMillis() || 0);
        });
        recalculateUnreadCounts();
      });
      
      conversationsListener = onSnapshot(dmsRef, snapshot => {
        conversations.clear();
        
        messageListeners.forEach(listener => listener());
        messageListeners.clear();
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.members && data.members.includes(currentUser)) {
            const convId = docSnap.id;
            conversations.set(convId, {
              id: convId,
              members: data.members,
              groupName: data.groupName || null,
              lastMessage: data.lastMessage || null
            });
            
            const messagesRef = collection(db, "dms", convId, "messages");
            const messagesQuery = query(messagesRef, orderBy("createdAt", "asc"));
            const unsubscribe = onSnapshot(messagesQuery, () => {
              recalculateUnreadCounts();
            });
            messageListeners.set(convId, unsubscribe);
          }
        });
        
        recalculateUnreadCounts();
      });
    }

    async function recalculateUnreadCounts() {
      const currentUser = auth.currentUser.displayName;
      let totalUnread = 0;
      
      for (const [convId, conv] of conversations) {
        if (convId === currentConversation) {
          conversationUnreadCounts.delete(convId);
          continue;
        }
        
        const messagesRef = collection(db, "dms", convId, "messages");
        const messagesSnapshot = await getDocs(messagesRef);
        
        const lastReadTime = readTimes.get(convId) || 0;
        let unreadForConv = 0;
        
        messagesSnapshot.forEach(msgDoc => {
          const msgData = msgDoc.data();
          const msgTime = msgData.createdAt?.toMillis() || 0;
          
          // Only count if: message is after last read, not from current user, and NOT deleted
          if (msgTime > lastReadTime && msgData.from !== currentUser && !msgData.deleted) {
            unreadForConv++;
          }
        });
        
        if (unreadForConv > 0) {
          conversationUnreadCounts.set(convId, unreadForConv);
          totalUnread += unreadForConv;
        } else {
          conversationUnreadCounts.delete(convId);
        }
      }
      
      unreadCount = totalUnread;
      updateConversationsList();
      updatePageTitle();
    }

    function updateConversationsList() {
      const container = document.getElementById("conversationsList");
      container.innerHTML = "";
      if (conversations.size === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-title">No conversations yet</div>
            <div>Start a DM or create a group!</div>
          </div>
        `;
        return;
      }
      conversations.forEach(conv => {
        const div = document.createElement("div");
        div.className = "conversation-item";
        if (currentConversation === conv.id) div.classList.add("active");
        
        const currentUser = auth.currentUser.displayName;
        const otherMembers = conv.members.filter(m => m !== currentUser);
        const displayName = conv.groupName || otherMembers.join(", ");
        const isGroup = conv.members.length > 2;
        
        let html = `
          <div class="conversation-info">
            <div class="conversation-name">${isGroup ? 'Group: ' : ''}${displayName}</div>
        `;
        
        if (isGroup) {
          html += `<div class="conversation-members">${conv.members.length} members</div>`;
        }
        
        html += `</div>`;
        
        const unreadForConv = conversationUnreadCounts.get(conv.id) || 0;
        if (unreadForConv > 0) {
          const displayCount = unreadForConv > 9 ? '9+' : unreadForConv;
          html += `<div class="unread-badge">${displayCount}</div>`;
        }
        
        html += `<button class="delete-conversation">√ó</button>`;
        
        div.innerHTML = html;
        
        div.querySelector(".conversation-info").onclick = () => selectConversation(conv.id);
        div.querySelector(".delete-conversation").onclick = (e) => {
          e.stopPropagation();
          if (isGroup) {
            leaveConversation(conv.id);
          } else {
            deleteConversation(conv.id);
          }
        };
        
        container.appendChild(div);
      });
    }

    async function selectConversation(conversationId) {
      currentConversation = conversationId;
      const conv = conversations.get(conversationId);
      const currentUser = auth.currentUser.displayName;
      const otherMembers = conv.members.filter(m => m !== currentUser);
      const displayName = conv.groupName || otherMembers.join(", ");
      const isGroup = conv.members.length > 2;
      
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("chatView").style.flexDirection = "column";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      
      document.getElementById("chatHeader").style.display = "flex";
      document.getElementById("chatTitle").textContent = (isGroup ? 'Group: ' : '') + displayName;
      
      if (isGroup) {
        document.getElementById("chatMembers").textContent = conv.members.join(", ");
      } else {
        document.getElementById("chatMembers").textContent = "";
      }
      
      document.getElementById("messageInputContainer").style.display = "block";
      document.getElementById("messageInput").disabled = false;
      document.getElementById("sendBtn").disabled = false;
      
      await markConversationAsRead(conversationId);
      
      const prevUnread = conversationUnreadCounts.get(conversationId) || 0;
      conversationUnreadCounts.delete(conversationId);
      unreadCount = Math.max(0, unreadCount - prevUnread);
      
      updateConversationsList();
      updatePageTitle();
      startDM(conversationId);
    }

    function startDM(conversationId) {
      if (currentDMListener) currentDMListener();
      const q = query(collection(db, "dms", conversationId, "messages"), orderBy("createdAt", "asc"));
      currentDMListener = onSnapshot(q, snapshot => {
        const container = document.getElementById("messagesContainer");
        container.innerHTML = "";
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const messageId = docSnap.id;
          
          // Skip deleted messages for regular users
          if (data.deleted) return;
          
          const div = document.createElement("div");
          div.className = "message";
          if (data.from === auth.currentUser?.displayName) {
            div.classList.add("own");
          }
          
          let timestamp = "";
          if (data.createdAt && userSettings.showTimestamps) {
            const date = data.createdAt.toDate();
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            
            if (isToday) {
              timestamp = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            } else {
              timestamp = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + 
                         date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }
          }
          
          const editedIndicator = data.edited ? '<span class="message-edited">(edited)</span>' : '';
          
          div.innerHTML = `
            <div class="message-header">
              <div class="message-author">${data.from}</div>
              <div class="message-timestamp">${timestamp}${editedIndicator}</div>
            </div>
            <div class="message-text">${data.text}</div>
          `;
          
          // Add edit/delete buttons only for own messages
          if (data.from === auth.currentUser?.displayName) {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            actionsDiv.innerHTML = `
              <button class="message-action-btn edit-btn" title="Edit">‚úèÔ∏è</button>
              <button class="message-action-btn delete-btn" title="Delete">üóëÔ∏è</button>
            `;
            div.appendChild(actionsDiv);
            
            actionsDiv.querySelector('.edit-btn').onclick = () => startEditMessage(conversationId, messageId, data.text);
            actionsDiv.querySelector('.delete-btn').onclick = () => deleteMessage(conversationId, messageId);
          }
          
          container.appendChild(div);
        });
        
        setTimeout(() => {
          container.scrollTop = 999999;
        }, 50);
        
        if (currentConversation === conversationId) {
          markConversationAsRead(conversationId);
        }
      });
    }

    document.getElementById("sendBtn").onclick = sendMessage;
    document.getElementById("messageInput").onkeypress = (e) => {
      if (e.key === 'Enter') sendMessage();
      if (e.key === 'Escape' && editingMessageId) {
        cancelEdit();
      }
    };

    function startEditMessage(conversationId, messageId, currentText) {
      editingMessageId = messageId;
      editingMessageText = currentText;
      const input = document.getElementById("messageInput");
      input.value = currentText;
      input.focus();
      input.select();
      document.getElementById("sendBtn").textContent = "‚úì";
      
      // Add cancel button
      const cancelBtn = document.createElement('button');
      cancelBtn.id = 'cancelEditBtn';
      cancelBtn.className = 'send-btn';
      cancelBtn.style.background = '#666';
      cancelBtn.textContent = '‚úï';
      cancelBtn.onclick = cancelEdit;
      document.querySelector('.message-input-wrapper').appendChild(cancelBtn);
    }

    function cancelEdit() {
      editingMessageId = null;
      editingMessageText = "";
      document.getElementById("messageInput").value = "";
      document.getElementById("sendBtn").textContent = "‚û§";
      const cancelBtn = document.getElementById('cancelEditBtn');
      if (cancelBtn) cancelBtn.remove();
    }

    async function deleteMessage(conversationId, messageId) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Delete Message</div>
          <div class="modal-content">
            <p style="color:#b9bbbe;">Are you sure you want to delete this message?</p>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn confirm">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('.confirm').onclick = async () => {
        try {
          await updateDoc(doc(db, "dms", conversationId, "messages", messageId), {
            deleted: true,
            deletedAt: serverTimestamp()
          });
          overlay.remove();
          showToast("Message deleted", "success");
        } catch (error) {
          showToast("Failed to delete message", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    async function sendMessage() {
      const text = document.getElementById("messageInput").value.trim();
      if (!currentConversation || !text) return;
      const conv = conversations.get(currentConversation);
      
      try {
        // Check if we're editing
        if (editingMessageId) {
          const messageRef = doc(db, "dms", currentConversation, "messages", editingMessageId);
          const messageDoc = await getDoc(messageRef);
          const originalText = messageDoc.data().originalText || messageDoc.data().text;
          
          await updateDoc(messageRef, {
            text: text,
            edited: true,
            editedAt: serverTimestamp(),
            originalText: originalText
          });
          
          cancelEdit();
          showToast("Message edited", "success");
        } else {
          // Normal send
          await setDoc(doc(db, "dms", currentConversation), {
            members: conv.members,
            groupName: conv.groupName || null,
            lastMessage: text,
            lastMessageTime: serverTimestamp()
          }, { merge: true });
          
          await addDoc(collection(db, "dms", currentConversation, "messages"), {
            from: auth.currentUser.displayName,
            text,
            createdAt: serverTimestamp(),
            deleted: false,
            edited: false
          });
          
          document.getElementById("messageInput").value = "";
        }
        
        await markConversationAsRead(currentConversation);
      } catch (error) {
        showToast("Failed to send message", "error");
      }
    }

    document.getElementById("friendsBtn").onclick = () => {
      document.getElementById("chatView").style.display = "none";
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("friendsView").style.display = "block";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById("friendsBtn").classList.add('active');
      loadFriends();
    };

    document.getElementById("settingsBtn").onclick = () => {
      document.getElementById("chatView").style.display = "none";
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("settingsView").style.display = "block";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById("settingsBtn").classList.add('active');
    };

    document.getElementById("newDmBtn").onclick = () => {
      showNewDmModal();
    };

    document.getElementById("backToMessagesBtn").onclick = () => {
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("chatView").style.flexDirection = "column";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    };

    document.getElementById("backFromSettingsBtn").onclick = () => {
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("chatView").style.flexDirection = "column";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    };

    document.querySelectorAll('.friends-tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.friends-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFriendsTab = tab.dataset.tab;
        if (currentFriendsTab === 'add') {
          document.getElementById('addFriendTab').style.display = 'block';
          document.getElementById('friendsListContainer').innerHTML = '';
        } else {
          document.getElementById('addFriendTab').style.display = 'none';
          loadFriends();
        }
      };
    });

    const addFriendInput = document.getElementById("addFriendInput");
    const addFriendDropdown = document.getElementById("addFriendDropdown");

    addFriendInput.oninput = () => {
      const searchTerm = addFriendInput.value.trim().toLowerCase();
      
      if (searchTerm.length === 0) {
        addFriendDropdown.style.display = 'none';
        return;
      }

      const matches = allUsers.filter(user => 
        user.username.toLowerCase().includes(searchTerm) || 
        user.displayName.toLowerCase().includes(searchTerm)
      );

      if (matches.length === 0) {
        addFriendDropdown.innerHTML = '<div class="user-select-item">No users found</div>';
        addFriendDropdown.style.display = 'block';
        return;
      }

      addFriendDropdown.innerHTML = '';
      matches.forEach(user => {
        const div = document.createElement('div');
        div.className = 'user-select-item';
        div.innerHTML = `
          <div>
            <div style="font-weight: 600;">${user.displayName}</div>
            <div style="font-size: 12px; color: #72767d;">@${user.username}</div>
          </div>
        `;
        div.onclick = async () => {
          addFriendInput.value = "";
          addFriendDropdown.style.display = 'none';
          
          if (user.displayName === auth.currentUser.displayName) {
            showToast("You can't add yourself as a friend!", "warning");
            return;
          }
          
          try {
            const friendRequestId = [auth.currentUser.displayName, user.displayName].sort().join("_");
            await setDoc(doc(db, "friendRequests", friendRequestId), {
              from: auth.currentUser.displayName,
              to: user.displayName,
              status: "pending",
              createdAt: serverTimestamp()
            });
            showToast("Friend request sent!", "success");
          } catch (error) {
            showToast("Failed to send friend request", "error");
          }
        };
        addFriendDropdown.appendChild(div);
      });

      addFriendDropdown.style.display = 'block';
    };

    document.addEventListener('click', (e) => {
      if (!addFriendInput.contains(e.target) && !addFriendDropdown.contains(e.target)) {
        addFriendDropdown.style.display = 'none';
      }
    });

    async function loadFriends() {
      const currentUser = auth.currentUser.displayName;
      
      if (friendsListener) friendsListener();
      
      const friendRequestsRef = collection(db, "friendRequests");
      friendsListener = onSnapshot(friendRequestsRef, async snapshot => {
        const friends = [];
        const pending = [];
        
        // Get all users to map displayNames
        const usersRef = collection(db, "users");
        const usersSnapshot = await getDocs(usersRef);
        const usersMap = new Map();
        usersSnapshot.forEach(doc => {
          const data = doc.data();
          usersMap.set(data.displayName || data.username, {
            username: data.username,
            displayName: data.displayName || data.username
          });
        });
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.from === currentUser || data.to === currentUser) {
            if (data.status === "accepted") {
              const friendDisplayName = data.from === currentUser ? data.to : data.from;
              const userData = usersMap.get(friendDisplayName) || { username: friendDisplayName, displayName: friendDisplayName };
              friends.push({ 
                displayName: friendDisplayName,
                username: userData.username,
                id: docSnap.id 
              });
            } else if (data.status === "pending") {
              if (data.to === currentUser) {
                const userData = usersMap.get(data.from) || { username: data.from, displayName: data.from };
                pending.push({ 
                  displayName: data.from,
                  username: userData.username,
                  id: docSnap.id, 
                  type: 'incoming' 
                });
              } else {
                const userData = usersMap.get(data.to) || { username: data.to, displayName: data.to };
                pending.push({ 
                  displayName: data.to,
                  username: userData.username,
                  id: docSnap.id, 
                  type: 'outgoing' 
                });
              }
            }
          }
        });
        
        displayFriendsList(friends, pending);
      });
    }

    function displayFriendsList(friends, pending) {
      const container = document.getElementById("friendsListContainer");
      container.innerHTML = "";
      
      if (currentFriendsTab === 'all') {
        if (friends.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No friends yet</div><div>Add some friends to get started!</div></div>';
          return;
        }
        friends.forEach(friend => {
          const div = document.createElement('div');
          div.className = 'friend-item';
          div.innerHTML = `
            <div>
              <div class="friend-name">${friend.displayName}</div>
              <div class="friend-status">@${friend.username}</div>
            </div>
            <div class="friend-actions">
              <button class="friend-btn message">Message</button>
              <button class="friend-btn remove">Remove</button>
            </div>
          `;
          div.querySelector('.message').onclick = () => startDMWithFriend(friend.displayName);
          div.querySelector('.remove').onclick = () => removeFriend(friend.id);
          container.appendChild(div);
        });
      } else if (currentFriendsTab === 'pending') {
        if (pending.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No pending requests</div></div>';
          return;
        }
        pending.forEach(request => {
          const div = document.createElement('div');
          div.className = 'friend-item';
          if (request.type === 'incoming') {
            div.innerHTML = `
              <div>
                <div class="friend-name">${request.displayName}</div>
                <div class="friend-status">@${request.username} ‚Ä¢ Incoming friend request</div>
              </div>
              <div class="friend-actions">
                <button class="friend-btn accept">Accept</button>
                <button class="friend-btn decline">Decline</button>
              </div>
            `;
            div.querySelector('.accept').onclick = () => acceptFriendRequest(request.id);
            div.querySelector('.decline').onclick = () => declineFriendRequest(request.id);
          } else {
            div.innerHTML = `
              <div>
                <div class="friend-name">${request.displayName}</div>
                <div class="friend-status">@${request.username} ‚Ä¢ Outgoing friend request</div>
              </div>
              <div class="friend-actions">
                <button class="friend-btn decline">Cancel</button>
              </div>
            `;
            div.querySelector('.decline').onclick = () => declineFriendRequest(request.id);
          }
          container.appendChild(div);
        });
      }
    }

    async function acceptFriendRequest(requestId) {
      try {
        await setDoc(doc(db, "friendRequests", requestId), {
          status: "accepted"
        }, { merge: true });
        showToast("Friend request accepted!", "success");
      } catch (error) {
        showToast("Failed to accept request", "error");
      }
    }

    async function declineFriendRequest(requestId) {
      try {
        await deleteDoc(doc(db, "friendRequests", requestId));
        showToast("Request removed", "success");
      } catch (error) {
        showToast("Failed to remove request", "error");
      }
    }

    async function removeFriend(friendId) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Remove Friend</div>
          <div class="modal-content">
            <p style="color:#b9bbbe;">Are you sure you want to remove this friend?</p>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn confirm">Remove</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('.confirm').onclick = async () => {
        try {
          await deleteDoc(doc(db, "friendRequests", friendId));
          overlay.remove();
          showToast("Friend removed", "success");
        } catch (error) {
          showToast("Failed to remove friend", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    async function startDMWithFriend(friendUsername) {
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("chatView").style.flexDirection = "column";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      
      const members = [auth.currentUser.displayName, friendUsername];
      const conversationId = getConversationId(members);
      
      if (!conversations.has(conversationId)) {
        try {
          await setDoc(doc(db, "dms", conversationId), {
            members,
            groupName: null,
            createdAt: serverTimestamp()
          });
        } catch (error) {
          showToast("Failed to start conversation", "error");
          return;
        }
      }
      
      setTimeout(() => {
        const items = document.querySelectorAll('.conversation-item');
        items.forEach(item => {
          const nameElem = item.querySelector('.conversation-name');
          if (nameElem && nameElem.textContent === friendUsername) {
            item.querySelector('.conversation-info').click();
          }
        });
      }, 500);
    }

    function showNewDmModal() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Create new message</div>
          <div class="modal-content">
            <label class="modal-label">Group name</label>
            <input type="text" class="modal-input" id="groupNameInput" placeholder="Leave empty for DM" />
            
            <label class="modal-label">Choose the people you want to talk to</label>
            <div style="position: relative;">
              <input type="text" class="modal-input" id="userSearchInput" placeholder="" autocomplete="off" />
              <div id="userSearchDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: #1a1a1a; border: 1px solid #333; border-radius: 5px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; margin-top: 5px;">
              </div>
            </div>
            
            <div class="selected-users" id="selectedUsersList"></div>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn create" id="createConvBtn">Create</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      loadFriendsForModal();
      
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    async function loadFriendsForModal() {
      const currentUser = auth.currentUser.displayName;
      const friendRequestsRef = collection(db, "friendRequests");
      const snapshot = await getDocs(friendRequestsRef);
      
      let friendsList = [];
      
      if (userSettings.allowNonFriendsDM) {
        friendsList = allUsers;
      } else {
        // Get display names of friends only
        const friendDisplayNames = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.status === "accepted") {
            if (data.from === currentUser) {
              friendDisplayNames.push(data.to);
            } else if (data.to === currentUser) {
              friendDisplayNames.push(data.from);
            }
          }
        });
        // Filter allUsers to only include friends
        friendsList = allUsers.filter(user => friendDisplayNames.includes(user.displayName));
      }
      
      const selectedUsers = new Set();
      const userSearchInput = document.getElementById('userSearchInput');
      const userSearchDropdown = document.getElementById('userSearchDropdown');
      const selectedUsersList = document.getElementById('selectedUsersList');
      
      userSearchInput.oninput = () => {
        const searchTerm = userSearchInput.value.trim().toLowerCase();
        
        if (searchTerm.length === 0) {
          userSearchDropdown.style.display = 'none';
          return;
        }

        const matches = friendsList.filter(user => 
          (user.username.toLowerCase().includes(searchTerm) || 
           user.displayName.toLowerCase().includes(searchTerm)) && 
          !selectedUsers.has(user.displayName)
        );

        if (matches.length === 0) {
          userSearchDropdown.innerHTML = '<div class="user-select-item">No users found</div>';
          userSearchDropdown.style.display = 'block';
          return;
        }

        userSearchDropdown.innerHTML = '';
        matches.forEach(user => {
          const div = document.createElement('div');
          div.className = 'user-select-item';
          div.innerHTML = `
            <div>
              <div style="font-weight: 600;">${user.displayName}</div>
              <div style="font-size: 12px; color: #72767d;">@${user.username}</div>
            </div>
          `;
          div.onclick = () => {
            selectedUsers.add(user.displayName);
            updateSelectedUsers();
            userSearchInput.value = '';
            userSearchDropdown.style.display = 'none';
          };
          userSearchDropdown.appendChild(div);
        });

        userSearchDropdown.style.display = 'block';
      };
      
      function updateSelectedUsers() {
        selectedUsersList.innerHTML = '';
        selectedUsers.forEach(displayName => {
          const tag = document.createElement('div');
          tag.className = 'selected-user-tag';
          tag.innerHTML = `
            ${displayName}
            <button class="remove-user">√ó</button>
          `;
          tag.querySelector('.remove-user').onclick = () => {
            selectedUsers.delete(displayName);
            updateSelectedUsers();
          };
          selectedUsersList.appendChild(tag);
        });
      }
      
      document.getElementById('createConvBtn').onclick = async () => {
        if (selectedUsers.size === 0) {
          showToast("Please select at least one user", "warning");
          return;
        }
        const groupName = document.getElementById('groupNameInput').value.trim();
        const members = [auth.currentUser.displayName, ...Array.from(selectedUsers)];
        const conversationId = getConversationId(members);
        
        try {
          await setDoc(doc(db, "dms", conversationId), {
            members,
            groupName: members.length > 2 ? (groupName || null) : null,
            createdAt: serverTimestamp()
          });
          document.querySelector('.modal-overlay').remove();
          showToast("Conversation created!", "success");
        } catch (error) {
          showToast("Failed to create conversation", "error");
        }
      };
      
      document.addEventListener('click', function closeDropdown(e) {
        if (!userSearchInput.contains(e.target) && !userSearchDropdown.contains(e.target)) {
          userSearchDropdown.style.display = 'none';
        }
        const modal = document.querySelector('.modal-overlay');
        if (!modal) {
          document.removeEventListener('click', closeDropdown);
        }
      });
    }

    function leaveConversation(conversationId) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Leave Group</div>
          <div class="modal-content">
            <p style="color:#b9bbbe;">Are you sure you want to leave this group?</p>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn confirm">Leave</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('.confirm').onclick = async () => {
        try {
          const currentUser = auth.currentUser.displayName;
          await updateDoc(doc(db, "dms", conversationId), {
            members: arrayRemove(currentUser)
          });
          
          if (currentConversation === conversationId) {
            currentConversation = null;
            document.getElementById("chatHeader").style.display = "none";
            document.getElementById("messageInputContainer").style.display = "none";
            document.getElementById("messagesContainer").innerHTML = `
              <div class="empty-state">
                <div>click on the buttons</div>
              </div>
            `;
          }
          overlay.remove();
          showToast("Left the group", "success");
        } catch (error) {
          showToast("Failed to leave group", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    function deleteConversation(conversationId) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Delete Conversation</div>
          <div class="modal-content">
            <p style="color:#b9bbbe;">This will remove all messages. Are you sure?</p>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn confirm">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('.confirm').onclick = async () => {
        try {
          const messagesRef = collection(db, "dms", conversationId, "messages");
          const messagesSnap = await getDocs(messagesRef);
          await Promise.all(messagesSnap.docs.map(d => deleteDoc(d.ref)));
          await deleteDoc(doc(db, "dms", conversationId));
          if (currentConversation === conversationId) {
            currentConversation = null;
            document.getElementById("chatHeader").style.display = "none";
            document.getElementById("messageInputContainer").style.display = "none";
            document.getElementById("messagesContainer").innerHTML = `
              <div class="empty-state">
                <div>click on the buttons</div>
              </div>
            `;
          }
          overlay.remove();
          showToast("Conversation deleted", "success");
        } catch (error) {
          showToast("Failed to delete conversation", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }
  </script>
</body>
</html>
